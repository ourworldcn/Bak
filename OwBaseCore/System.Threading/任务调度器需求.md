# 核心功能需求
## 任务存储与合并
- **队列结构**：维护一个队列存放待执行任务，忽略任务优先级问题。  
- **相同类型任务合并**：如果队列中已存在相同 `typeId` 的任务，则只保留最新任务的执行逻辑，合并处理。

## 任务定义与执行
- **执行函数**：签名为 `Func<object, bool>`，返回 `true` 表示执行成功，`false` 或抛出异常均视为失败。  
- **执行顺序**：不需严格 FIFO，但尽量保持先提交先执行。  
- **低优先级线程**：使用一个低优先级线程顺序执行队列中的任务（可根据需求配置）。  

## 锁定机制
- **SingletonLocker**：在执行任务前，可调用静态类 `SingletonLocker` 根据 `typeId` 尝试加锁，若锁定失败则将任务放回队列，不阻塞其他任务。

## 线程与并发
- **执行线程**：可采用单线程或简化的多线程，避免过多并发冲突。  
- **队列容量**：可通过配置指定队列上限，默认不限制。

## 服务生命周期
- **依赖注入**：支持 Microsoft.Extensions.DependencyInjection。  
- **服务停止**：通过检测 `IHostApplicationLifetime.Stopped`，在停止前尽量执行完队列中剩余任务。

## 日志
- **日志记录**：使用 .NET 6 日志框架记录任务执行情况，执行失败仅记录，无失败重试逻辑。

# 执行流程
## 提交任务
- **Enqueue 方法**：提交任务时指定 `typeId`、执行逻辑及是否需要锁定。  
- **相同任务合并**：若已存在同 `typeId` 的任务，则合并为一个，仅保留最新执行逻辑。  

## 任务执行
- **从队列移除**：当开始尝试执行任务时，立刻将其从队列中取出。  
- **ProcessAll 方法**：依次执行队列中的任务，若需锁定则尝试 `SingletonLocker`，锁定失败的任务将被放回队列，不阻塞其它任务。  
- **异常处理**：任务执行失败后仅记录日志，并将其彻底移除或根据需求进行自定义处理。  

## 结果处理
- **完成后不考虑同类型**：任务执行完成后无需判断队列中是否存在同类型任务，已执行的任务不再返回到队列。  
- **不提供手动移除接口**：暂时不提供移除特定任务的功能。  

# 非功能需求
- **性能要求**：在总体上保持先到先执行，不做严格 FIFO 限制。  
- **扩展性**：为多线程、重试和监控等功能预留扩展空间。  
- **可维护性**：压缩不必要的换行。注释尽量放在行尾。  

# 类名称
- 建议使用“TaskDispatcher”作为满足以上需求的类名。