# 核心功能需求

## 任务存储与优先级

- **队列结构**：内部维护一个支持顺序操作的队列结构，支持任务优先级设置（int 类型，数值越低优先级越高）。
- **相同类型任务**：对于相同类型 ID 的任务，只执行最新的一个，入队时自动移除相同类型 ID 的旧任务。

## 任务定义与执行

- **执行函数**：任务执行函数使用 `Func<object, bool>` 形式，返回 true 表示执行成功，返回 false 或抛出异常均视为失败。
- **单线程执行**：使用单个线程按顺序执行任务，不使用 `async/await`，按优先级顺序处理任务，不考虑任务执行超时机制。

## 失败重试机制

- **重试策略**：所有任务共用相同的重试策略，任务失败后按均匀间隔时间（默认 1 秒）进行重试。
- **重试次数**：重试次数可配置，超过限制后记录日志并丢弃任务。

## 任务查询与管理

- **任务查询**：提供方法查询某个特定类型 ID 的任务是否在队列中。
- **任务移除**：支持从队列中手动移除特定任务的功能。

## 线程与并发

- **单线程提交与执行**：所有任务的提交与执行均使用单个线程进行，确保顺序执行，避免并发操作。
- **队列容量**：队列容量不设上限限制。

## 服务生命周期

- **依赖注入**：支持依赖注入（Microsoft.Extensions.DependencyInjection）。
- **服务停止**：在服务停止时，确保队列中待执行的任务全部完成。
- **系统重启**：系统重启后，可以抛弃之前未完成的任务。

## 日志与监控

- **日志记录**：使用 .NET 6 自带的日志框架记录任务执行情况。
- **监控指标**：提供任务执行统计信息，如成功率、平均执行时间等监控指标，监控指标仅在内存中维护，不需要持久化。

# 执行流程

## 提交任务

- **Enqueue 方法**：外部调用提交方法（Enqueue）并指定 `typeId`、优先级和执行逻辑。
- **移除旧任务**：若已存在相同 `typeId` 的旧任务，则移除旧任务，保留新任务。

## 单线程执行

- **ProcessAll 方法**：在 ProcessAll 方法中，按优先级从队列取出任务。
- **判断最新任务**：判断是否仍为最新任务，若是则执行。
- **捕获返回值与异常**：执行任务并捕获返回值与异常。

## 重试与放弃

- **失败重试**：任务失败且重试次数未超限，则按固定间隔（1 秒）进行重试。
- **重试上限**：重试次数达上限，则记录日志并舍弃任务。

## 结果处理与统计

- **移除任务**：成功或放弃的任务均不再保留，避免堆积。
- **记录结果**：记录任务执行结果到监控统计中。

# 非功能需求

## 性能要求

- **顺序执行**：确保任务按提交顺序执行，避免并发引起的数据一致性问题。

## 扩展性

- **未来扩展**：保留接口以支持未来可能增加的功能，预留多线程执行模式的扩展空间。

## 可维护性

- **代码结构**：代码结构清晰，提供注释和文档，完善日志机制，便于问题排查。

# 监控指标

- **队列当前长度**：实时统计队列当前长度。
- **任务执行成功率**：统计任务执行成功率。
- **任务平均执行时间**：统计任务的平均执行时间。
- **任务重试次数**：统计任务的重试次数。
- **按任务类型分组**：按任务类型 ID 分组的执行统计信息。
